# Registro de un nuevo agente
A continuación se detalla el proceso para el registro de un nuevo servidor a traves de la línea de comandos

## Configuración del servidor Maestro
Para ingresar al servidor maestro de Wazuh ejecutamos el comando:

```bash
docker exec -it wazuh bash
```

Una vez dentro procedemos a dar de alta un nuevo agente a traves del comando:

```bash
/var/ossec/bin/manage_agents
```

Desplegando un menú como el siguiente:

```bash
****************************************
* Wazuh v3.6.1 Agent manager.          *
* The following options are available: *
****************************************
   (A)dd an agent (A).
   (E)xtract key for an agent (E).
   (L)ist already added agents (L).
   (R)emove an agent (R).
   (Q)uit.
Choose your action: A,E,L,R or Q:
```
En el cual seleccionamos la opcion **A**.
**Es importante tener a la mano la dirección del servidor que vamos a registrar.**

Enseguida observaremos un menu como el siguiente, el cual nos permitira dar de alta el servidor:

```bash
- Adding a new agent (use '\q' to return to the main menu).
  Please provide the following:
   * A name for the new agent: Example
   * The IP Address of the new agent: any
   * An ID for the new agent[001]:
Agent information:
   ID:001
   Name:Example
   IP Address:any

Confirm adding it?(y/n): y
Agent added with ID 001.
```

Donde:
* **A name for the new agent:** Es un nombre que le otorgaremos al servidor como simple identificador.
* **The IP Address of the new agent:** Corresponde a la dirección IP del servidor que registraremos.
* **An ID for the new agent[001]:** Es el identificador que Wazuh le otorga. En este punto no tecleamos nada, solo damos enter.

Despues de confirmar los campos anteriores, regresaremos de nuevo al menu principal, en el cual seleccionaremos la opción **E**:

```bash
****************************************
* Wazuh v3.6.1 Agent manager.          *
* The following options are available: *
****************************************
   (A)dd an agent (A).
   (E)xtract key for an agent (E).
   (L)ist already added agents (L).
   (R)emove an agent (R).
   (Q)uit.
Choose your action: A,E,L,R or Q:
```

Enseguida tecleamos el ID que Wazuh le da al nuevo agente _(An ID for the new agent[001])_ para finalmente obtener una salida como la siguiente:

```bash
Available agents:
   ID: 001, Name: Example, IP: any
Provide the ID of the agent to extract the key (or '\q' to quit): 001

Agent key information for '001' is:
MDAxIDE4NWVlNjE1Y2YzYiBhbnkgMGNmMDFiYTM3NmMxY2JjNjU0NDAwYmFhZDY1ZWU1YjcyMGI2NDY3ODhkNGQzMjM5ZTdlNGVmNzQzMGFjMDA4Nw==
```

Donde:
* **Agent key information for '001' is:** Es el token que permitira establecer la comunicación entre el maestro y el agente.

Hasta este punto la configuración en el servidor Maestro ha finalizado, por lo que en el menú principal seleccionamos la opción **Q**.

## Configuración del Agente

Una vez dentro del agente ejecutamos el comando:

```bash
/var/ossec/bin/manage_agents
```

El cual nos desplegará un menú como el siguiente:

```bash
****************************************
* Wazuh v3.6.1 Agent manager.          *
* The following options are available: *
****************************************
   (I)mport key from the server (I).
   (Q)uit.
Choose your action: I or Q:
```

Donde seleccionaremos la opción **I**.
**Es importante tener a la mano el token que obtuvimos en la configuración del servidor Maestro.**

A continuación ingresamos el token que obtuvimos con anterioridad y escribimos **y** para confirmar, se mostrará una salida como la siguiente:

```bash
* Provide the Key generated by the server.
* The best approach is to cut and paste it.
*** OBS: Do not include spaces or new lines.

Paste it here (or '\q' to quit): MDAxIDE4NWVlNjE1Y2YzYiBhbnkgMGNmMDFiYTM3NmMxY2JjNjU0NDAwYmFhZDY1ZWU1YjcyMGI2NDY3ODhkNGQzMjM5ZTdlNGVmNzQzMGFjMDA4Nw=

Agent information:
   ID:013
   Name:Example
   IP Address:any

Confirm adding it?(y/n): y
Added.
```
Finalmente modificamos el archivo **/var/ossec/etc/ossec.conf** sustituyendo la linea **MANAGE_IP** por la dirección IP del nodo maestro.

```conf
<client>
    <server>
      <address>MANAGE_IP</address>
      <port>1514</port>
      <protocol>udp</protocol>
    </server>
```

**Hasta este punto tanto el agente como el maestro ya se conocen**